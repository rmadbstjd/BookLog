<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>북로그 수정</title>
    <!-- JQuery & Bootstrap import -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <!-- Local CSS & JS import -->
    <link rel="stylesheet" href="{{ url_for("static", filename="style.css") }}"/>
    <script src="{{ url_for("static", filename="script.js") }}"></script>

    <!-- 이 페이지만 : 파일업로더 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/bs-custom-file-input/dist/bs-custom-file-input.js"></script>

    <!-- 이 페이지 전용 script -->
    <script>
      
      
      /* $("#button-to-openmodal").click(function(){
        var data = $('#booknameSearch').val();
          $("#contents.body-contents").val(data);
          $("#text-contents.body-contents").html(data);
      }); */

      $(document).ready(function () {
        bsCustomFileInput.init();
        //listing();
      });

      function booksearch_listing() {

        var data = $('#booknameSearch').val();

        $.ajax({
          type: "POST",
          url: "/api/call-bookinfo",
          data: { query : data },
          contentType: 'text/plain; charset=UTF-8',
          success: function (response) {
            console.log(response)
            $("#selectData_table").empty();
            for (let i = 0; i < response.items.length; i++) {
              let title = response.items[i]["title"];
              let author = response.items[i]["author"];
              let isbn = response.items[i]["isbn"].toString().split(' ')[1]
              let image_url = response.items[i]["image"];

              let temp_html = `<tr>
                                  <th scope="row"><img src="${image_url}"></img></th>
                                  <td>${title}</td>
                                  <td>${author}</td>
                                  <td><a  type="button" class="btn btn-primary"
                                    style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;" href="/edit-page/${isbn}" >
                              선택
                            </a></td>
                                </tr>`;
                                
              $("#selectData_table").append(temp_html);
              console.log(data)
            }
          },
        });

      } 

      function posting() {
        
        // 포스팅할 데이터 취합
        let booktitle = $("#booktitle").val()
        let review_content = $("#review_content").val();
        let img_url = $("#image_url")[0]['src'].split('?')[0];

        // FormData 객체에 담아, 전송 준비
        let form_data = new FormData();

        form_data.append("imgfile_give", img_url);
        form_data.append("booktitle_give", booktitle);
        form_data.append("review_content_give", review_content);

        // ajax : POST 방식으로 save-review 주소에 전송 (python에서 처리한 후 response 보내면, msg 찾아 alert) 
        // data에 "form_data" 객체를 담아 전송 

        $.ajax({
          type: "POST",
          url: "/save-review",
          data: form_data,
          cache: false,
          contentType: false,
          processData: false,
          success: function (response) {
            window.location.reload();
          },
        });
      
        
      }

    </script>
  </head>

  <body>
    <div class="header mb-5 ">
      <button type="button" class="btn btn-secondary">로그인</button>
      <button type="button" class="btn btn-secondary">회원가입</button>
    </div>
  
    <div class="container-fluid mb-5 ">
      <h1 class="MainTitle mb-5 ">BookLog 작성</h1>
    </div>

    <div class="container mt-5"> 

      <!-- 네이버 책 API 활용 기능 추가 예정 : https://developers.naver.com/apps/#/register?defaultScope=search -->
      <div class="mb-5">
        <label for="booknameSearch" class="form-label">네이버 도서 검색</label>
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="booknameSearch" placeholder="도서명" >
          <button class="btn btn-outline-secondary" type="button" id="button-to-openmodal" onclick="booksearch_listing();" data-bs-toggle="modal" data-bs-target="#exampleModal" >도서 검색</button>
          <!-- <button class="btn btn-outline-secondary" type="button" id="button-to-openmodal" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="booksearch_listing()">도서 검색</button> -->
        </div>
      </div>

      <form>
        <div class="mb-3">

          {% if image %}
          <img id="image_url" src="{{image}}" class="img-fluid" alt="" >
          <span>표지이미지</span>
          {%endif%}
          
        </div>

        <div class="mb-3">
          <label for="booktitle" class="form-label">책 제목</label>
          <input type="text" class="form-control" id="booktitle" placeholder="책 제목을 입력해주세요." value="{% if title %} {{title}} {% else %} 책제목 {%endif%}" required>
        </div>
        <div class="mb-3">
          <label for="review_content" class="form-label" >책 감상평</label>
          <textarea class="form-control" id="review_content" rows="20" required></textarea>
        </div>
        <div class="mb-3 text-center">
        <button type="submit" class="btn btn-primary" onclick="posting();">등록</button>
        <button type="button" class="btn btn-secondary">뒤로 가기</button>
        </div>
      </form>

      <!-- Modal -->

      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl ">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">도서 검색 결과</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">제목</th>
                    <th scope="col">저자</th>
                    <th scope="col">선택</th>
                  </tr>
                </thead>
                <tbody id="selectData_table">
                </tbody>
              </table>
              
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
          </div>
        </div>
      </div>

    </div>



  </body>

</html>
