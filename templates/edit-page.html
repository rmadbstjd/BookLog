<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>북로그 수정</title>
    <!-- JQuery & Bootstrap import -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <!-- Local CSS & JS import -->
    <link rel="stylesheet" href="{{ url_for("static", filename="style.css") }}"/>
    <script src="{{ url_for("static", filename="script.js") }}"></script>

    <!-- 이 페이지만 : 파일업로더 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/bs-custom-file-input/dist/bs-custom-file-input.js"></script> 

    <!-- 이 페이지 전용 script -->
    <script>
      
      
      /* $("#button-to-openmodal").click(function(){
        var data = $('#booknameSearch').val();
          $("#contents.body-contents").val(data);
          $("#text-contents.body-contents").html(data);
      }); */

      $(document).ready(function () {
        bsCustomFileInput.init();
        //listing();
      });

      /* 모달을 열자 */

      function booksearch_listing() {
        /* 관련 책자 찾아서 데이터로 받아 보기 */ 

        var data = $('#booknameSearch').val();
        $.ajax({
          type: "POST",
          url: "/api/call-bookinfo",
          data: data,
          cache: false,
          contentType: false,
          processData: false,
          success: function (response) {
            console.log(response)
            $("#selectData_table").empty();
            for (let i = 0; i < response.items.length; i++) {
              let title = response.items[i]["title"];
              let author = response.items[i]["author"];
              let isbn = response.items[i]["isbn"];
              let image_url = response.items[i]["image"];

              let temp_html = `<tr>
                                  <th scope="row">1</th>
                                  <td>${title}</td>
                                  <td>${author}</td>
                                  <td><button type="button" class="btn btn-primary"
                                    style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                              선택
                            </button></td>
                                </tr>`;
                                
              $("#selectData_table").append(temp_html);
            }
          },
        });



      } 

      /* function listing() {
        $.ajax({
          type: "GET",
          url: "/diary",
          data: {},
          success: function (response) {
            let diaries = response["all_diary"];
            for (let i = 0; i < diaries.length; i++) {
              let title = diaries[i]["title"];
              let content = diaries[i]["content"];
              let file = diaries[i]["file"];
              let time = diaries[i]["time"];

              let temp_html = `<div class="card">
                                            <img src="../static/${file}" class="card-img-top">
                                            <div class="card-body">
                                                <h5 class="card-title">${title}</h5>
                                                <p class="card-text">${content}</p>
                                                <p class="save-date">${time}</p>
                                            </div>
                                        </div>`;
              $("#cards-box").append(temp_html);
            }
          },
        });
      } */

      function posting() {

        // 포스팅할 데이터 취합
        let booktitle = $("#booktitle").val();
        let review_content = $("#review_content").val();
        let imgfile = $("#imgfile")[0].files[0];

        // FormData 객체에 담아, 전송 준비
        let form_data = new FormData();
        form_data.append("imgfile_give", imgfile);
        form_data.append("booktitle_give", booktitle);
        form_data.append("review_content_give", review_content);

        // ajax : POST 방식으로 save-review 주소에 전송 (python에서 처리한 후 response 보내면, msg 찾아 alert) 
        // data에 "form_data" 객체를 담아 전송 

        $.ajax({
          type: "POST",
          url: "/save-review",
          data: form_data,
          cache: false,
          contentType: false,
          processData: false,
          success: function (response) {
            alert(response["msg"]);
            window.location.reload();
          },
        });
      }

    </script>
  </head>

  <body>
    <div class="header mb-5 ">
      <button type="button" class="btn btn-secondary">로그인</button>
      <button type="button" class="btn btn-secondary">회원가입</button>
    </div>

    <div class="container-fluid mb-5 ">
      <h1 class="MainTitle mb-5 ">BookLog 작성</h1>
    </div>

    <div class="container mt-5">

      <!-- 네이버 책 API 활용 기능 추가 예정 : https://developers.naver.com/apps/#/register?defaultScope=search -->
      <form class="mb-5">
        <label for="booknameSearch" class="form-label">네이버 도서 검색</label>
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="booknameSearch" placeholder="도서명">
          <button class="btn btn-outline-secondary" type="button" id="button-to-openmodal" onclick="booksearch_listing();" data-bs-toggle="modal" data-bs-target="#exampleModal" >도서 검색</button>
          <!-- <button class="btn btn-outline-secondary" type="button" id="button-to-openmodal" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="booksearch_listing()">도서 검색</button> -->
        </div>
      </form>

      <form>
        <div class="mb-3">
          <label for="imgfile" class="form-label">사진 선택하기</label>
          <input type="file" class="form-control" id="imgfile" />
        </div>

        <div class="mb-3">
          <label for="booktitle" class="form-label">책제목</label>
          <input type="text" class="form-control" id="booktitle" placeholder="책 제목을 적어주세요">
        </div>
        <div class="mb-3">
          <label for="review_content" class="form-label">책 감상평</label>
          <textarea class="form-control" id="review_content" rows="20"></textarea>
        </div>
        <div class="mb-3 text-center">
        <button type="submit" class="btn btn-primary" onclick="posting()">등록</button>
        <button type="button" class="btn btn-secondary">뒤로 가기</button>
        </div>
      </form>

      <!-- Modal -->

      <div class="modal fade modal-xl	" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">도서 검색 결과</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">제목</th>
                    <th scope="col">저자</th>
                    <th scope="col">선택</th>
                  </tr>
                </thead>
                <tbody id="selectData_table">
                </tbody>
              </table>
              
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
              <button type="button" class="btn btn-primary">검색결과 선택</button>
            </div>
          </div>
        </div>
      </div>

    </div>

  </body>

</html>
